<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>怪物火车 2 数据查询</title>
  <link rel="stylesheet" href="css/style.css">

  <script type="module" src="./script/image-toggle-button.js"></script>
  <script type="module" src="./script/section-divider.js"></script>
  <script type="module" src="./script/search-panel.js"></script>
  <script type="module" src="./script/item-card.js"></script>
  <script type="module" src="./script/search-tag.js"></script>
  <script type="module" src="./script/util.js"></script>
  <script type="module" src="./data/monster-train-2/index.js"></script>
</head>

<body>
  <header>
    <p>怪物火车 2 数据查询</p>
  </header>
  <main>
    <div class="left-panel card-list-view">
      <item-card src="image/cards/不朽交易.webp" class=""></item-card>
      <item-card src="image/cards/不朽交易.webp" class=""></item-card>
      <item-card src="image/cards/不朽交易.webp" class=""></item-card>
      <item-card src="image/cards/不朽交易.webp" class=""></item-card>
    </div>
    <!-- 查询条件面板 -->
    <search-panel class="right-panel"></search-panel>
  </main>
  <footer>
    <p>&copy; 2025 By K_r_o_s</p>
  </footer>
  <div id="z-tooltip" style="position: fixed; pointer-events: none;"></div>
  <template id="item-card-template" id="button">
    <div class="card-container">
      <img class="card-image">
      <div class="card-name"></div>
      <div class="card-effect-area">
        <p class="card-effect"></p>
      </div>
    </div>
  </template>
  <template id="image-toggle-button-template">
    <button div class="image-toggle-button button-size56x56" id="button">
      <img id="image">
    </button>
  </template>
  <template id="section-divider-template">
    <div class="section-divider" id="divider"></div>
  </template>
  <template id="search-tag-template">
    <div class="search-tag-text">
      <span></span>
      <button class="search-tag-clear-button">❌</button>
    </div>
  </template>
  <template id="search-panel-template">
    <!-- 查询输入框和按钮区 -->
    <div class="search-container">
      <input type="search" id="search-input" placeholder="请输入搜索条件..." list="search-list">
      <datalist id="search-list">
        <option value="迅捷">
        <option value="横扫">
        <option value="多重攻击">
        <option value="英勇">
        <option value="薪火熔胶">
        <option value="月相循环">
        <option value="导流">
        <option value="生长">
        <option value="散播">
        <option value="不稳定">
        <option value="狂怒">
        <option value="护甲">
        <option value="尖刺">
        <option value="舍弃">
        <option value="暴食">
        <option value="燃命">
      </datalist>
      <button id="search-button">🔎</button>
    </div>
    <div class="search-tag-list"></div>
    <!-- 卡牌氏族选取区 -->
    <section-divider text="氏族"></section-divider>
    <div id="clan-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/流放者.webp" condition="clan:流放者" title="流放者"></image-toggle-button>
      <image-toggle-button src="image/other/薪龙族.webp" condition="clan:薪龙族" title="薪龙族"></image-toggle-button>
      <image-toggle-button src="image/other/月巫团.webp" condition="clan:月巫团" title="月巫团"></image-toggle-button>
      <image-toggle-button src="image/other/地下菌团.webp" condition="clan:地下菌团" title="地下菌团"></image-toggle-button>
      <image-toggle-button src="image/other/拉撒路联盟.webp" condition="clan:拉撒路联盟" title="拉撒路联盟"></image-toggle-button>
      <image-toggle-button src="image/other/狱魔.webp" condition="clan:狱魔" title="狱魔"></image-toggle-button>
      <image-toggle-button src="image/other/觉者.webp" condition="clan:觉者" title="觉者"></image-toggle-button>
      <image-toggle-button src="image/other/冥卫.webp" condition="clan:冥卫" title="冥卫"></image-toggle-button>
      <image-toggle-button src="image/other/影主.webp" condition="clan:影主" title="影主"></image-toggle-button>
      <image-toggle-button src="image/other/熔尸.webp" condition="clan:熔尸" title="熔尸"></image-toggle-button>
      <image-toggle-button src="image/other/无氏族.webp" condition="clan:无氏族" title="无氏族"></image-toggle-button>
    </div>
    <!-- 卡牌类型选取区 -->
    <section-divider text="类型"></section-divider>
    <div id="type-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/单位.webp" condition="type:单位" title="单位" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/法术.webp" condition="type:法术" title="法术" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/装备.webp" condition="type:装备" title="装备" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/房间.webp" condition="type:房间" title="房间" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/神器.webp" condition="type:神器" title="神器" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/升级石.webp" condition="type:升级石" title="升级石"
        size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/祸患.webp" condition="type:祸患" title="祸患" size="42x48"
        off="1"></image-toggle-button>
      <image-toggle-button src="image/other/天灾.webp" condition="type:天灾" title="天灾" size="42x48"
        off="1"></image-toggle-button>
    </div>
    <!-- 卡牌稀有度选取区 -->
    <section-divider text="稀有度"></section-divider>
    <div id="rarity-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/勇者.webp" condition="rarity:勇者" title="勇者"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/普通.webp" condition="rarity:普通" title="普通"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/高级.webp" condition="rarity:高级" title="高级"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/稀有.webp" condition="rarity:稀有" title="稀有"
        size="42x42"></image-toggle-button>
    </div>
    <!-- 卡牌费用选取区 -->
    <section-divider text="费用"></section-divider>
    <div id="cost-section" class="image-toggle-button-group">
      <image-toggle-button src="" text="0" condition="cost:0" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="1" condition="cost:1" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="2" condition="cost:2" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="3" condition="cost:3" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="4+" condition="cost:4;cost:5;cost:6;cost:7;cost:8"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="X" condition="cost:X" size="42x42"></image-toggle-button>
    </div>
    <!-- 标签选取区 -->
    <section-divider text="标签"></section-divider>
  </template>
  <script type="module">
    import { __DEBUG, __log_data } from './script/util.js'
    import { MT_DATA } from './data/monster-train-2/index.js'

    let ztooltip = null;
    let leftPanel = null;
    let animationFrameId = 0;

    document.addEventListener('DOMContentLoaded', () => {
      ztooltip = document.querySelector('#z-tooltip');
      leftPanel = document.querySelector('.left-panel');
      const searchPanel = document.querySelector('.right-panel');

      // 加载上次页面最后一次搜索条件
      loadSavedQuery();

      // 搜索文本框
      searchPanel.searchInput.addEventListener('keyup', () => {
        // 按回车
        if (event.key === 'Enter') {
          event.preventDefault();
          doSearch();
        }
      });
      // 搜索按钮
      searchPanel.searchButton.addEventListener('click', () => { doSearch(); });
      // 各个氏族/种类/稀有度/费用 等按钮
      searchPanel.toggleButtons.map((btn) => {
        btn.addEventListener('click', () => { doSearch(); })
        btn.addEventListener('dblclick', () => { doSearch(); })
      });

      doSearch();
    });
    function loadSavedQuery() {
      const queryString = localStorage.getItem('queryState');
      try {
        const query = JSON.parse(queryString);
        __log_data("loaded query", query);
        const searchPanel = document.querySelector('.right-panel');
        searchPanel.setQuery(query);
      } catch (e) {
        console.error("query string: [" + queryString + "] is not valid");
      }
    }
    function doSearch() {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }

      const searchPanel = document.querySelector('.right-panel');
      const query = {
        // 移除一些特殊字符 !@#$%^&*\/ 和 空白字符
        "text": searchPanel.searchInput.value.replace(/!@#\$%\^&\*\\\/\s/g, ''),
        "clan": [],
        "type": [],
        "rarity": [],
        "cost": [],
      };
      searchPanel.conditions.map((condition) => {
        const pair = condition.split(":");
        if (!pair || pair.length != 2) {
          console.error("invalid condition: [" + condition + "]"); return;
        }
        if (__DEBUG) {
          if (!["clan", "type", "rarity", "cost"].includes(pair[0])) {
            console.error("invalid condition: [" + condition + "]"); return;
          }
        }
        query[pair[0]].push(pair[1]);
      })
      localStorage.setItem('queryState', JSON.stringify(query));
      const result = [];
      MT_DATA.forEach((item) => {
        if (!query.clan.includes(item.clan)) { return; }
        if (!query.type.includes(item.type)) { return; }
        if (!["神器", "升级石"].includes(item.type)) {
          if (!query.rarity.includes(item.rarity)) { return; }
          if (!query.cost.includes(item.cost)) { return; }
        }
        if (query.text
          && (!item.text || !item.text.includes(query.text))
          && (!item.name || !item.name.includes(query.text))
        ) { return; }
        result.push(item);
      });

      createCardList(result);
      const text = query.text;
      if (result.length > 0 && text.length > 0) {
        searchPanel.addSearchTag(text, () => {
          searchPanel.searchInput.value = text;
          doSearch();
        });
      }
    }

    function createCardList(result) {
      function createCard(item, animating) {
        // <item-card src="image/cards/不朽交易.webp" class=""></item-card>
        const card = document.createElement('item-card');
        card.item = item;
        switch (item.type) {
          case "神器":
            card.setAttribute("src", "image/artifacts/" + item.name + ".webp");
            break;
          case "升级石":
            card.setAttribute("src", "image/other/" + item.name + ".webp");
            break;
          default:
            card.setAttribute("src", "image/cards/" + item.name + ".webp");
            break;
        }
        card.addEventListener('mouseenter', (e) => {
          const mouseX = event.pageX;
          const mouseY = event.pageY;
          ztooltip.innerHTML = e.target.termsHtml;

          const panelRect = leftPanel.getBoundingClientRect();
          const cardRect = e.target.getBoundingClientRect();
          const tooltipRect = ztooltip.getBoundingClientRect();
          ztooltip.style.left = cardRect.right + "px";
          // 避免过于靠下
          // 不是很靠下
          if (cardRect.top + tooltipRect.height < panelRect.bottom) {
            ztooltip.style.top = cardRect.top + "px";
          }
          // 靠下
          else {
            ztooltip.style.top = panelRect.bottom - tooltipRect.height - 2 + "px";
          }
          // 避免过于靠上
          if (cardRect.top < panelRect.top) {
            ztooltip.style.top = panelRect.top + "px";
          }
          ztooltip.style.visibility = 'visible';
        });
        card.addEventListener('mouseleave', (e) => {
          ztooltip.style.visibility = 'hidden';
        })
        card.onAdded(animating);

        return card;
      }
      const cardList = leftPanel.querySelectorAll("item-card");
      for (let i = 0; i < cardList.length; i++) {
        cardList[i].onBeingRemoved();
      }
      leftPanel.innerHTML = "";
      let count = result.length;
      if (count > 30) {
        result.map((item) => leftPanel.appendChild(createCard(item, false)));
      } else {
        if (count < 1) { return; }
        let i = 0;
        let lastAddTime = 0;
        function createCardWithAnimation(currentTime) {
          if (currentTime - lastAddTime >= 160) {
            leftPanel.appendChild(createCard(result[i], true));
            if (++i >= count) {
              cancelAnimationFrame(animationFrameId);
              animationFrameId = null;
              return;
            }
            lastAddTime = currentTime; // 更新上次添加时间
          }

          // 继续请求下一帧动画
          animationFrameId = requestAnimationFrame(createCardWithAnimation);
        }
        animationFrameId = requestAnimationFrame(createCardWithAnimation);
      }
    }
  </script>
</body>

</html>