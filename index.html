<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Web Page</title>
  <link rel="stylesheet" href="css/style.css">

  <script type="module" src="./script/image-toggle-button.js"></script>
  <script type="module" src="./script/section-divider.js"></script>
  <script type="module" src="./script/search-panel.js"></script>
  <script type="module" src="./script/item-card.js"></script>
  <script type="module" src="./script/util.js"></script>
  <script type="module" src="./data/monster-train-2/index.js"></script>
</head>

<body>
  <header>
    <p>Welcome to My Web Page</p>
  </header>
  <main>
    <div class="left-panel card-list-view">
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
      <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
    </div>
    <!-- Êü•ËØ¢Êù°‰ª∂Èù¢Êùø -->
    <search-panel class="right-panel"></search-panel>
  </main>
  <footer>
    <p>&copy; Jul 2025 By Kros</p>
  </footer>
  <div id="z-tooltip" style="position: fixed; pointer-events: none;"></div>
  <template id="item-card-template" id="button">
    <div class="card-container">
      <img class="card-image">
      <div class="card-name"></div>
      <div class="card-effect-area">
        <p class="card-effect"></p>
      </div>
    </div>
  </template>
  <template id="image-toggle-button-template">
    <button div class="image-toggle-button button-size56x56" id="button">
      <img id="image">
    </button>
  </template>
  <template id="section-divider-template">
    <div class="section-divider" id="divider"></div>
  </template>
  <template id="search-panel-template">
    <!-- Êü•ËØ¢ËæìÂÖ•Ê°ÜÂíåÊåâÈíÆÂå∫ -->
    <div class="search-container">
      <input type="text" id="search-input" placeholder="ËØ∑ËæìÂÖ•ÊêúÁ¥¢Êù°‰ª∂...">
      <button id="search-button">üîé</button>
    </div>
    <!-- Âç°ÁâåÊ∞èÊóèÈÄâÂèñÂå∫ -->
    <section-divider text="Ê∞èÊóè"></section-divider>
    <div id="clan-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/ÊµÅÊîæËÄÖ.webp" condition="clan:ÊµÅÊîæËÄÖ" title="ÊµÅÊîæËÄÖ"></image-toggle-button>
      <image-toggle-button src="image/other/Ëñ™ÈæôÊóè.webp" condition="clan:Ëñ™ÈæôÊóè" title="Ëñ™ÈæôÊóè"></image-toggle-button>
      <image-toggle-button src="image/other/ÊúàÂ∑´Âõ¢.webp" condition="clan:ÊúàÂ∑´Âõ¢" title="ÊúàÂ∑´Âõ¢"></image-toggle-button>
      <image-toggle-button src="image/other/Âú∞‰∏ãËèåÂõ¢.webp" condition="clan:Âú∞‰∏ãËèåÂõ¢" title="Âú∞‰∏ãËèåÂõ¢"></image-toggle-button>
      <image-toggle-button src="image/other/ÊãâÊííË∑ØËÅîÁõü.webp" condition="clan:ÊãâÊííË∑ØËÅîÁõü" title="ÊãâÊííË∑ØËÅîÁõü"></image-toggle-button>
      <image-toggle-button src="image/other/Áã±È≠î.webp" condition="clan:Áã±È≠î" title="Áã±È≠î"></image-toggle-button>
      <image-toggle-button src="image/other/ËßâËÄÖ.webp" condition="clan:ËßâËÄÖ" title="ËßâËÄÖ"></image-toggle-button>
      <image-toggle-button src="image/other/ÂÜ•Âç´.webp" condition="clan:ÂÜ•Âç´" title="ÂÜ•Âç´"></image-toggle-button>
      <image-toggle-button src="image/other/ÂΩ±‰∏ª.webp" condition="clan:ÂΩ±‰∏ª" title="ÂΩ±‰∏ª"></image-toggle-button>
      <image-toggle-button src="image/other/ÁÜîÂ∞∏.webp" condition="clan:ÁÜîÂ∞∏" title="ÁÜîÂ∞∏"></image-toggle-button>
      <image-toggle-button src="image/other/Êó†Ê∞èÊóè.webp" condition="clan:Êó†Ê∞èÊóè" title="Êó†Ê∞èÊóè"></image-toggle-button>
    </div>
    <!-- Âç°ÁâåÁ±ªÂûãÈÄâÂèñÂå∫ -->
    <section-divider text="Á±ªÂûã"></section-divider>
    <div id="type-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/Âçï‰Ωç.webp" condition="type:Âçï‰Ωç" title="Âçï‰Ωç" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/Ê≥ïÊúØ.webp" condition="type:Ê≥ïÊúØ" title="Ê≥ïÊúØ" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/Ë£ÖÂ§á.webp" condition="type:Ë£ÖÂ§á" title="Ë£ÖÂ§á" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/ÊàøÈó¥.webp" condition="type:ÊàøÈó¥" title="ÊàøÈó¥" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/Á•ûÂô®.webp" condition="type:Á•ûÂô®" title="Á•ûÂô®" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/ÂçáÁ∫ßÁü≥.webp" condition="type:ÂçáÁ∫ßÁü≥" title="ÂçáÁ∫ßÁü≥" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/Á•∏ÊÇ£.webp" condition="type:Á•∏ÊÇ£" title="Á•∏ÊÇ£" size="42x48" off></image-toggle-button>
      <image-toggle-button src="image/other/Â§©ÁÅæ.webp" condition="type:Â§©ÁÅæ" title="Â§©ÁÅæ" size="42x48" off></image-toggle-button>
    </div>
    <!-- Âç°ÁâåÁ®ÄÊúâÂ∫¶ÈÄâÂèñÂå∫ -->
    <section-divider text="Á®ÄÊúâÂ∫¶"></section-divider>
    <div id="rarity-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/ÂãáËÄÖ.webp" condition="rarity:ÂãáËÄÖ" title="ÂãáËÄÖ"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/ÊôÆÈÄö.webp" condition="rarity:ÊôÆÈÄö" title="ÊôÆÈÄö"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/È´òÁ∫ß.webp" condition="rarity:È´òÁ∫ß" title="È´òÁ∫ß"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/Á®ÄÊúâ.webp" condition="rarity:Á®ÄÊúâ" title="Á®ÄÊúâ"
        size="42x42"></image-toggle-button>
    </div>
    <!-- Âç°ÁâåË¥πÁî®ÈÄâÂèñÂå∫ -->
    <section-divider text="Ë¥πÁî®"></section-divider>
    <div id="cost-section" class="image-toggle-button-group">
      <image-toggle-button src="" text="0" condition="cost:0" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="1" condition="cost:1" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="2" condition="cost:2" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="3" condition="cost:3" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="4+" condition="cost:4;cost:5;cost:6;cost:7;cost:8"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="X" condition="cost:X" size="42x42"></image-toggle-button>
    </div>
    <!-- Ê†áÁ≠æÈÄâÂèñÂå∫ -->
    <section-divider text="Ê†áÁ≠æ"></section-divider>
  </template>
  <script type="module">
    import { __DEBUG } from './script/util.js'
    import { MT_DATA } from './data/monster-train-2/index.js'

    let ztooltip = null;
    let leftPanel = null;
    let animationFrameId = 0;

    document.addEventListener('DOMContentLoaded', () => {
      ztooltip = document.querySelector('#z-tooltip');
      leftPanel = document.querySelector('.left-panel');
      const searchPanel = document.querySelector('.right-panel');
      // ÊêúÁ¥¢ÊñáÊú¨Ê°Ü
      searchPanel.searchInput.addEventListener('keyup', () => {
        // ÊåâÂõûËΩ¶
        if (event.key === 'Enter') {
          event.preventDefault();
          doSearch();
        }
      });
      // ÊêúÁ¥¢ÊåâÈíÆ
      searchPanel.searchButton.addEventListener('click', () => { doSearch(); });
      // ÂêÑ‰∏™Ê∞èÊóè/ÁßçÁ±ª/... ÊåâÈíÆ
      searchPanel.toggleButtons.map((btn) => {
        btn.addEventListener('click', () => { doSearch(); })
      });

      doSearch();
    });

    function doSearch() {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }

      const searchPanel = document.querySelector('.right-panel');
      const search = {
        // ÁßªÈô§‰∏Ä‰∫õÁâπÊÆäÂ≠óÁ¨¶ !@#$%^&*\/ Âíå Á©∫ÁôΩÂ≠óÁ¨¶
        "text": searchPanel.searchInput.value.replace(/!@#\$%\^&\*\\\/\s/g, ''),
        "clan": [],
        "type": [],
        "rarity": [],
        "cost": [],
      };
      searchPanel.conditions.map((condition) => {
        const pair = condition.split(":");
        if (!pair || pair.length != 2) {
          console.error("invalid condition: [" + condition + "]"); return;
        }
        if (__DEBUG) {
          if (!["clan", "type", "rarity", "cost"].includes(pair[0])) {
            console.error("invalid condition: [" + condition + "]"); return;
          }
        }
        search[pair[0]].push(pair[1]);
      })
      const result = [];
      MT_DATA.forEach((item) => {
        if (!search.clan.includes(item.clan)) { return; }
        if (!search.type.includes(item.type)) { return; }
        if (!["Á•ûÂô®", "ÂçáÁ∫ßÁü≥"].includes(item.type)) {
          if (!search.rarity.includes(item.rarity)) { return; }
          if (!search.cost.includes(item.cost)) { return; }
        }
        if (search.text 
          && (!item.text || !item.text.includes(search.text))
          && (!item.name || !item.name.includes(search.text))
        ) { return; }
        result.push(item);
      });

      createCardList(result);
    }

    function createCardList(result) {
      function createCard(item, animating) {
        // <item-card src="image/cards/‰∏çÊúΩ‰∫§Êòì.webp" class=""></item-card>
        const card = document.createElement('item-card');
        card.item = item;
        switch (item.type) {
          case "Á•ûÂô®":
            card.setAttribute("src", "image/artifacts/" + item.name + ".webp");
            break;
          case "ÂçáÁ∫ßÁü≥":
            card.setAttribute("src", "image/other/" + item.name + ".webp");
            break;
          default:
            card.setAttribute("src", "image/cards/" + item.name + ".webp");
            break;
        }
        card.addEventListener('mouseenter', (e) => {
          const mouseX = event.pageX;
          const mouseY = event.pageY;
          ztooltip.innerHTML = e.target.termsHtml;

          const panelRect = leftPanel.getBoundingClientRect();
          const cardRect = e.target.getBoundingClientRect();
          const tooltipRect = ztooltip.getBoundingClientRect();
          ztooltip.style.left = cardRect.right + "px";
          // ÈÅøÂÖçËøá‰∫éÈù†‰∏ã
          // ‰∏çÊòØÂæàÈù†‰∏ã
          if (cardRect.top + tooltipRect.height < panelRect.bottom) {
            ztooltip.style.top = cardRect.top + "px";
          }
          // Èù†‰∏ã
          else {
            ztooltip.style.top = panelRect.bottom - tooltipRect.height - 2 + "px";
          }
          // ÈÅøÂÖçËøá‰∫éÈù†‰∏ä
          if (cardRect.top < panelRect.top) {
            ztooltip.style.top = panelRect.top + "px";
          }
          ztooltip.style.visibility = 'visible';
        });
        card.addEventListener('mouseleave', (e) => {
          ztooltip.style.visibility = 'hidden';
        })
        card.onAdded(animating);

        return card;
      }
      const cardList = leftPanel.querySelectorAll("item-card");
      for (let i = 0; i < cardList.length; i++) {
        cardList[i].onBeingRemoved();
      }
      leftPanel.innerHTML = "";
      let count = result.length;
      if (count > 30) {
        result.map((item) => leftPanel.appendChild(createCard(item, false)));
      } else {
        if (count < 1) { return; }
        let i = 0;
        let lastAddTime = 0;
        function createCardWithAnimation(currentTime) {
          if (currentTime - lastAddTime >= 160) {
            leftPanel.appendChild(createCard(result[i], true));
            if (++i >= count) {
              cancelAnimationFrame(animationFrameId);
              animationFrameId = null;
              return;
            }
            lastAddTime = currentTime; // Êõ¥Êñ∞‰∏äÊ¨°Ê∑ªÂä†Êó∂Èó¥
          }

          // ÁªßÁª≠ËØ∑Ê±Ç‰∏ã‰∏ÄÂ∏ßÂä®Áîª
          animationFrameId = requestAnimationFrame(createCardWithAnimation);
        }
        animationFrameId = requestAnimationFrame(createCardWithAnimation);
      }
    }
  </script>
</body>

</html>