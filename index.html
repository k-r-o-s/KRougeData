<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>怪物火车 2 数据查询</title>
  <link rel="stylesheet" href="css/style.css">

  <script type="module" src="./script/image-toggle-button.js"></script>
  <script type="module" src="./script/section-divider.js"></script>
  <script type="module" src="./script/search-panel.js"></script>
  <script type="module" src="./script/item-card.js"></script>
  <script type="module" src="./script/search-tag.js"></script>
  <script type="module" src="./script/util.js"></script>
  <script type="module" src="./data/monster-train-2/index.js"></script>
</head>

<body>
  <header>
    <p>怪物火车 2 数据查询</p>
  </header>
  <main>
    <div class="left-panel card-list-view">
      <item-card src="image/cards/不朽交易.webp" class=""></item-card>
      <item-card src="image/cards/不朽交易.webp" class=""></item-card>
      <item-card src="image/cards/不朽交易.webp" class=""></item-card>
      <item-card src="image/cards/不朽交易.webp" class=""></item-card>
    </div>
    <!-- 查询条件面板 -->
    <search-panel class="right-panel"></search-panel>
  </main>
  <footer>
    <p>&copy; 2025 By K_r_o_s</p>
  </footer>
  <div id="z-tooltip" style="position: fixed; pointer-events: none;"></div>

  <script type="module">
    import { __DEBUG, __log_data } from './script/util.js'
    import { MT_DATA } from './data/monster-train-2/index.js'

    let ztooltip = null;
    let leftPanel = null;
    let animationFrameId = 0;

    document.addEventListener('DOMContentLoaded', () => {
      ztooltip = document.querySelector('#z-tooltip');
      leftPanel = document.querySelector('.left-panel');
      const searchPanel = document.querySelector('.right-panel');

      // 加载上次页面最后一次搜索条件
      loadSavedQuery();

      // 搜索文本框
      searchPanel.searchInput.addEventListener('keyup', () => {
        // 按回车
        if (event.key === 'Enter') {
          event.preventDefault();
          doSearch();
        }
      });
      // 搜索按钮
      searchPanel.searchButton.addEventListener('click', () => { doSearch(); });
      // 各个氏族/种类/稀有度/费用 等按钮
      searchPanel.toggleButtons.map((btn) => {
        btn.addEventListener('click', () => { doSearch(); })
        btn.addEventListener('dblclick', () => { doSearch(); })
      });

      doSearch();
    });
    function loadSavedQuery() {
      const queryString = localStorage.getItem('queryState');
      try {
        const query = JSON.parse(queryString);
        __log_data("loaded query", query);
        const searchPanel = document.querySelector('.right-panel');
        searchPanel.setQuery(query);
      } catch (e) {
        console.error("query string: [" + queryString + "] is not valid");
      }
    }
    function doSearch() {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }

      const searchPanel = document.querySelector('.right-panel');
      const query = {
        // 移除一些特殊字符 !@#$%^&*\/ 和 空白字符
        "text": searchPanel.searchInput.value.replace(/!@#\$%\^&\*\\\/\s/g, ''),
        "clan": [],
        "type": [],
        "rarity": [],
        "cost": [],
      };
      searchPanel.conditions.map((condition) => {
        const pair = condition.split(":");
        if (!pair || pair.length != 2) {
          console.error("invalid condition: [" + condition + "]"); return;
        }
        if (__DEBUG) {
          if (!["clan", "type", "rarity", "cost"].includes(pair[0])) {
            console.error("invalid condition: [" + condition + "]"); return;
          }
        }
        query[pair[0]].push(pair[1]);
      })
      localStorage.setItem('queryState', JSON.stringify(query));
      const result = [];
      MT_DATA.forEach((item) => {
        if (!query.clan.includes(item.clan)) { return; }
        if (!query.type.includes(item.type)) { return; }
        if (!["神器", "升级石"].includes(item.type)) {
          if (!query.rarity.includes(item.rarity)) { return; }
          if (!query.cost.includes(item.cost)) { return; }
        }
        if (query.text
          && (!item.text || !item.text.includes(query.text))
          && (!item.name || !item.name.includes(query.text))
        ) { return; }
        result.push(item);
      });

      createCardList(result);
      const text = query.text;
      if (result.length > 0 && text.length > 0) {
        searchPanel.addSearchTag(text, () => {
          searchPanel.searchInput.value = text;
          doSearch();
        });
      }
    }

    function createCardList(result) {
      function createCard(item, animating) {
        // <item-card src="image/cards/不朽交易.webp" class=""></item-card>
        const card = document.createElement('item-card');
        card.item = item;
        switch (item.type) {
          case "神器":
            card.setAttribute("src", "image/artifacts/" + item.name + ".webp");
            break;
          case "升级石":
            card.setAttribute("src", "image/other/" + item.name + ".webp");
            break;
          default:
            card.setAttribute("src", "image/cards/" + item.name + ".webp");
            break;
        }
        card.addEventListener('mouseenter', (e) => {
          const mouseX = event.pageX;
          const mouseY = event.pageY;
          ztooltip.innerHTML = e.target.termsHtml;

          const panelRect = leftPanel.getBoundingClientRect();
          const cardRect = e.target.getBoundingClientRect();
          const tooltipRect = ztooltip.getBoundingClientRect();
          ztooltip.style.left = cardRect.right + "px";
          // 避免过于靠下
          // 不是很靠下
          if (cardRect.top + tooltipRect.height < panelRect.bottom) {
            ztooltip.style.top = cardRect.top + "px";
          }
          // 靠下
          else {
            ztooltip.style.top = panelRect.bottom - tooltipRect.height - 2 + "px";
          }
          // 避免过于靠上
          if (cardRect.top < panelRect.top) {
            ztooltip.style.top = panelRect.top + "px";
          }
          ztooltip.style.visibility = 'visible';
        });
        card.addEventListener('mouseleave', (e) => {
          ztooltip.style.visibility = 'hidden';
        })
        card.onAdded(animating);

        return card;
      }
      const cardList = leftPanel.querySelectorAll("item-card");
      for (let i = 0; i < cardList.length; i++) {
        cardList[i].onBeingRemoved();
      }
      leftPanel.innerHTML = "";
      let count = result.length;
      if (count > 30) {
        result.map((item) => leftPanel.appendChild(createCard(item, false)));
      } else {
        if (count < 1) { return; }
        let i = 0;
        let lastAddTime = 0;
        function createCardWithAnimation(currentTime) {
          if (currentTime - lastAddTime >= 160) {
            leftPanel.appendChild(createCard(result[i], true));
            if (++i >= count) {
              cancelAnimationFrame(animationFrameId);
              animationFrameId = null;
              return;
            }
            lastAddTime = currentTime; // 更新上次添加时间
          }

          // 继续请求下一帧动画
          animationFrameId = requestAnimationFrame(createCardWithAnimation);
        }
        animationFrameId = requestAnimationFrame(createCardWithAnimation);
      }
    }
  </script>
</body>

</html>