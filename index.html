<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Web Page</title>
  <link rel="stylesheet" href="css/style.css">

  <script type="module" src="./script/image-toggle-button.js"></script>
  <script type="module" src="./script/section-divider.js"></script>
  <script type="module" src="./script/search-panel.js"></script>
  <script type="module" src="./script/item-card.js"></script>
  <script type="module" src="./script/util.js"></script>
  <script type="module" src="./data/monster-train-2/index.js"></script>
</head>

<body>
  <header>
    <p>Welcome to My Web Page</p>
  </header>
  <main>
    <div class="left-panel card-list-view">
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
      <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
    </div>
    <!-- æŸ¥è¯¢æ¡ä»¶é¢æ¿ -->
    <search-panel class="right-panel"></search-panel>
  </main>
  <footer>
    <p>&copy; Jul 2025 By Kros</p>
  </footer>
  <div id="z-tooltip" style="position: fixed; pointer-events: none;"></div>
  <template id="item-card-template" id="button">
    <div class="card-container">
      <img class="card-image">
      <div class="card-name"></div>
      <div class="card-effect-area">
        <p class="card-effect"></p>
      </div>
    </div>
  </template>
  <template id="image-toggle-button-template">
    <button div class="image-toggle-button button-size56x56" id="button">
      <img id="image">
    </button>
  </template>
  <template id="section-divider-template">
    <div class="section-divider" id="divider"></div>
  </template>
  <template id="search-panel-template">
    <!-- æŸ¥è¯¢è¾“å…¥æ¡†å’ŒæŒ‰é’®åŒº -->
    <div class="search-container">
      <input type="text" id="search-input" placeholder="è¯·è¾“å…¥æœç´¢æ¡ä»¶...">
      <button id="search-button">ğŸ”</button>
    </div>
    <!-- å¡ç‰Œæ°æ—é€‰å–åŒº -->
    <section-divider text="æ°æ—"></section-divider>
    <div id="clan-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/æµæ”¾è€….webp" condition="clan:æµæ”¾è€…" title="æµæ”¾è€…"></image-toggle-button>
      <image-toggle-button src="image/other/è–ªé¾™æ—.webp" condition="clan:è–ªé¾™æ—" title="è–ªé¾™æ—"></image-toggle-button>
      <image-toggle-button src="image/other/æœˆå·«å›¢.webp" condition="clan:æœˆå·«å›¢" title="æœˆå·«å›¢"></image-toggle-button>
      <image-toggle-button src="image/other/åœ°ä¸‹èŒå›¢.webp" condition="clan:åœ°ä¸‹èŒå›¢" title="åœ°ä¸‹èŒå›¢"></image-toggle-button>
      <image-toggle-button src="image/other/æ‹‰æ’’è·¯è”ç›Ÿ.webp" condition="clan:æ‹‰æ’’è·¯è”ç›Ÿ" title="æ‹‰æ’’è·¯è”ç›Ÿ"></image-toggle-button>
      <image-toggle-button src="image/other/ç‹±é­”.webp" condition="clan:ç‹±é­”" title="ç‹±é­”"></image-toggle-button>
      <image-toggle-button src="image/other/è§‰è€….webp" condition="clan:è§‰è€…" title="è§‰è€…"></image-toggle-button>
      <image-toggle-button src="image/other/å†¥å«.webp" condition="clan:å†¥å«" title="å†¥å«"></image-toggle-button>
      <image-toggle-button src="image/other/å½±ä¸».webp" condition="clan:å½±ä¸»" title="å½±ä¸»"></image-toggle-button>
      <image-toggle-button src="image/other/ç†”å°¸.webp" condition="clan:ç†”å°¸" title="ç†”å°¸"></image-toggle-button>
      <image-toggle-button src="image/other/æ— æ°æ—.webp" condition="clan:æ— æ°æ—" title="æ— æ°æ—"></image-toggle-button>
    </div>
    <!-- å¡ç‰Œç±»å‹é€‰å–åŒº -->
    <section-divider text="ç±»å‹"></section-divider>
    <div id="type-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/å•ä½.webp" condition="type:å•ä½" title="å•ä½" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/æ³•æœ¯.webp" condition="type:æ³•æœ¯" title="æ³•æœ¯" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/è£…å¤‡.webp" condition="type:è£…å¤‡" title="è£…å¤‡" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/æˆ¿é—´.webp" condition="type:æˆ¿é—´" title="æˆ¿é—´" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/ç¥å™¨.webp" condition="type:ç¥å™¨" title="ç¥å™¨" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/å‡çº§çŸ³.webp" condition="type:å‡çº§çŸ³" title="å‡çº§çŸ³" size="42x48"></image-toggle-button>
      <image-toggle-button src="image/other/ç¥¸æ‚£.webp" condition="type:ç¥¸æ‚£" title="ç¥¸æ‚£" size="42x48" off></image-toggle-button>
      <image-toggle-button src="image/other/å¤©ç¾.webp" condition="type:å¤©ç¾" title="å¤©ç¾" size="42x48" off></image-toggle-button>
    </div>
    <!-- å¡ç‰Œç¨€æœ‰åº¦é€‰å–åŒº -->
    <section-divider text="ç¨€æœ‰åº¦"></section-divider>
    <div id="rarity-section" class="image-toggle-button-group">
      <image-toggle-button src="image/other/å‹‡è€….webp" condition="rarity:å‹‡è€…" title="å‹‡è€…"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/æ™®é€š.webp" condition="rarity:æ™®é€š" title="æ™®é€š"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/é«˜çº§.webp" condition="rarity:é«˜çº§" title="é«˜çº§"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="image/other/ç¨€æœ‰.webp" condition="rarity:ç¨€æœ‰" title="ç¨€æœ‰"
        size="42x42"></image-toggle-button>
    </div>
    <!-- å¡ç‰Œè´¹ç”¨é€‰å–åŒº -->
    <section-divider text="è´¹ç”¨"></section-divider>
    <div id="cost-section" class="image-toggle-button-group">
      <image-toggle-button src="" text="0" condition="cost:0" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="1" condition="cost:1" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="2" condition="cost:2" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="3" condition="cost:3" size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="4+" condition="cost:4;cost:5;cost:6;cost:7;cost:8"
        size="42x42"></image-toggle-button>
      <image-toggle-button src="" text="X" condition="cost:X" size="42x42"></image-toggle-button>
    </div>
    <!-- æ ‡ç­¾é€‰å–åŒº -->
    <section-divider text="æ ‡ç­¾"></section-divider>
  </template>
  <script type="module">
    import { __DEBUG } from './script/util.js'
    import { MT_DATA } from './data/monster-train-2/index.js'

    let ztooltip = null;
    let leftPanel = null;
    let animationFrameId = 0;

    document.addEventListener('DOMContentLoaded', () => {
      ztooltip = document.querySelector('#z-tooltip');
      leftPanel = document.querySelector('.left-panel');
      const searchPanel = document.querySelector('.right-panel');
      // æœç´¢æ–‡æœ¬æ¡†
      searchPanel.searchInput.addEventListener('keyup', () => {
        // æŒ‰å›è½¦
        if (event.key === 'Enter') {
          event.preventDefault();
          doSearch();
        }
      });
      // æœç´¢æŒ‰é’®
      searchPanel.searchButton.addEventListener('click', () => { doSearch(); });
      // å„ä¸ªæ°æ—/ç§ç±»/... æŒ‰é’®
      searchPanel.toggleButtons.map((btn) => {
        btn.addEventListener('click', () => { doSearch(); })
      });

      doSearch();
    });

    function doSearch() {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }

      const searchPanel = document.querySelector('.right-panel');
      const search = {
        // ç§»é™¤ä¸€äº›ç‰¹æ®Šå­—ç¬¦ !@#$%^&*\/ å’Œ ç©ºç™½å­—ç¬¦
        "text": searchPanel.searchInput.value.replace(/!@#\$%\^&\*\\\/\s/g, ''),
        "clan": [],
        "type": [],
        "rarity": [],
        "cost": [],
      };
      searchPanel.conditions.map((condition) => {
        const pair = condition.split(":");
        if (!pair || pair.length != 2) {
          console.error("invalid condition: [" + condition + "]"); return;
        }
        if (__DEBUG) {
          if (!["clan", "type", "rarity", "cost"].includes(pair[0])) {
            console.error("invalid condition: [" + condition + "]"); return;
          }
        }
        search[pair[0]].push(pair[1]);
      })
      const result = [];
      MT_DATA.forEach((item) => {
        if (!search.clan.includes(item.clan)) { return; }
        if (!search.type.includes(item.type)) { return; }
        if (!["ç¥å™¨", "å‡çº§çŸ³"].includes(item.type)) {
          if (!search.rarity.includes(item.rarity)) { return; }
          if (!search.cost.includes(item.cost)) { return; }
        }
        if (search.text 
          && (!item.text || !item.text.includes(search.text))
          && (!item.name || !item.name.includes(search.text))
        ) { return; }
        result.push(item);
      });

      createCardList(result);
    }

    function createCardList(result) {
      function createCard(item, animating) {
        // <item-card src="image/cards/ä¸æœ½äº¤æ˜“.webp" class=""></item-card>
        const card = document.createElement('item-card');
        card.item = item;
        switch (item.type) {
          case "ç¥å™¨":
            card.setAttribute("src", "image/artifacts/" + item.name + ".webp");
            break;
          case "å‡çº§çŸ³":
            card.setAttribute("src", "image/other/" + item.name + ".webp");
            break;
          default:
            card.setAttribute("src", "image/cards/" + item.name + ".webp");
            break;
        }
        card.addEventListener('mouseenter', (e) => {
          const mouseX = event.pageX;
          const mouseY = event.pageY;
          ztooltip.innerHTML = e.target.termsHtml;

          const panelRect = leftPanel.getBoundingClientRect();
          const cardRect = e.target.getBoundingClientRect();
          const tooltipRect = ztooltip.getBoundingClientRect();
          ztooltip.style.left = cardRect.right + "px";
          // é¿å…è¿‡äºé ä¸‹
          // ä¸æ˜¯å¾ˆé ä¸‹
          if (cardRect.top + tooltipRect.height < panelRect.bottom) {
            ztooltip.style.top = cardRect.top + "px";
          }
          // é ä¸‹
          else {
            ztooltip.style.top = panelRect.bottom - tooltipRect.height - 2 + "px";
          }
          // é¿å…è¿‡äºé ä¸Š
          if (cardRect.top < panelRect.top) {
            ztooltip.style.top = panelRect.top + "px";
          }
          ztooltip.style.visibility = 'visible';
        });
        card.addEventListener('mouseleave', (e) => {
          ztooltip.style.visibility = 'hidden';
        })
        card.onAdded(animating);

        return card;
      }
      const cardList = leftPanel.querySelectorAll("item-card");
      for (let i = 0; i < cardList.length; i++) {
        cardList[i].onBeingRemoved();
      }
      leftPanel.innerHTML = "";
      let count = result.length;
      if (count > 30) {
        result.map((item) => leftPanel.appendChild(createCard(item, false)));
      } else {
        if (count < 1) { return; }
        let i = 0;
        let lastAddTime = 0;
        function createCardWithAnimation(currentTime) {
          if (currentTime - lastAddTime >= 160) {
            leftPanel.appendChild(createCard(result[i], true));
            if (++i >= count) {
              cancelAnimationFrame(animationFrameId);
              animationFrameId = null;
              return;
            }
            lastAddTime = currentTime; // æ›´æ–°ä¸Šæ¬¡æ·»åŠ æ—¶é—´
          }

          // ç»§ç»­è¯·æ±‚ä¸‹ä¸€å¸§åŠ¨ç”»
          animationFrameId = requestAnimationFrame(createCardWithAnimation);
        }
        animationFrameId = requestAnimationFrame(createCardWithAnimation);
      }
    }
  </script>
</body>

</html>